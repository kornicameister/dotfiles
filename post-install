#!/usr/bin/env bash

install_pyenv_plugins() {
    local plugins_dir
    local plugins

    plugins_dir=$(realpath "${PWD}/dependencies/pyenv/plugins/")
    plugins=(
        pyenv-update
        pyenv-virtualenv
        pyenv-ccache
        pyenv-doctor
        pyenv-install-latest
    )

    mkdir -p "${plugins_dir}"
    for plugin in ${plugins[*]}; do
        if [ ! -d "${plugins_dir}/${plugin}" ]; then
            git clone "git://github.com/pyenv/${plugin}.git" "${plugins_dir}/${plugin}"
        fi
    done
}

install_nodenv_plugins() {
    local plugins_dir
    local plugins

    plugins_dir=$(realpath "${PWD}/dependencies/nodenv/plugins/")
    plugins=(
        nodenv-update
        nodenv-aliases
        nodenv-package-json-engine
        nodenv-package-rehash
        nodenv-each
        node-build
    )

    mkdir -p "${plugins_dir}"
    for plugin in ${plugins[*]}; do
        if [ ! -d "${plugins_dir}/${plugin}" ]; then
            git clone "git://github.com/nodenv/${plugin}.git" "${plugins_dir}/${plugin}"
        fi
    done
}

install_latest_dev() {
    echo "Installing python & node"
    pyenv install-latest -s 2.7
    pyenv install-latest -s 3.7
    nodenv install -s "$(cat ./node-system-version)"
}

init_neovim() (
    echo "Initializing neovim setup"

    if [ ! -d "${PYENV_ROOT}/versions/neovim2" ]; then
        pyenv virtualenv "$(pyenv install-latest -s 2.7 | sed s/Install\\s//g | sed s/\\.\\.\\.//g)" neovim2
        "${PYENV_ROOT}"/versions/neovim2/bin/pip install --upgrade -r ./neovim-requirements.txt
        pyenv rehash
    else
        echo "${PYENV_ROOT}/versions/neovim2 venv already exists"
    fi
    if [ ! -d "${PYENV_ROOT}/versions/neovim3" ]; then
        pyenv virtualenv "$(pyenv install-latest -s 3.7 | sed s/Install\\s//g | sed s/\\.\\.\\.//g)" neovim3
        "${PYENV_ROOT}"/versions/neovim3/bin/pip install --upgrade -r ./neovim-requirements.txt
        pyenv rehash
    else
        echo "${PYENV_ROOT}/versions/neovim3 venv already exists"
    fi

    if command -v npm >/dev/null 2>&1; then
        npm install -g neovim typescript
        if command -v nodenv >/dev/null 2>&1; then
            nodenv rehash
        fi
    fi

)

init_python_system() (
    rm -rf "${PWD}/dependencies/pyenv/version"
    echo "system" > "${PWD}/dependencies/pyenv/version"
)

post_init_python_system () (
    pip install setuptools pip wakatime --upgrade
)

(
    "${PWD}/dependencies/fzf/install" --all ;
    "${PWD}/dependencies/nerd-fonts/install.sh Hack" ;
    install_pyenv_plugins ;
    install_nodenv_plugins ;
    init_python_system ;
    post_init_python_system ;
    install_latest_dev ;
    init_neovim
)
