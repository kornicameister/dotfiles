---
version: 2.1
jobs:
  submodules:
    machine: true
    steps:
      - checkout
      - run:
          name: "Submodules :: checkout"
          command: .circleci/submodules_step.sh

  build_arch:
    docker:
      - image: archlinux:latest
    steps:
      - checkout
      - run: |
          locale-gen en_US.UTF-8
          ln -fs /usr/share/zoneinfo/Europe/Warsaw /etc/localtime

          mkdir -p /var/lib/pacman/local /var/lib/pacman/sync

          patched_glibc=glibc-linux4-2.33-4-x86_64.pkg.tar.zst && \
            curl -LO "https://repo.archlinuxcn.org/x86_64/$patched_glibc" && \
            bsdtar -C / -xvf "$patched_glibc"
      - run: |
          pacman -Sy --noconfirm sudo

          useradd -m -r -s /bin/bash aur
          passwd -d aur
          echo 'aur ALL=(ALL) ALL' > /etc/sudoers.d/aur

          mkdir -p /home/aur/.gnupg
          echo 'standard-resolver' > /home/aur/.gnupg/dirmngr.conf

          chown -R aur:aur /home/aur
      - run:
          name: Run an installation
          command: |
            su - aur
            ./install \
              --git-username "${CIRCLE_PROJECT_USERNAME}" \
              --git-password "${CIRCLE_BUILD_NUM}" \
              --git-email "${CIRCLE_PROJECT_USERNAME}@${CIRCLE_PROJECT_REPONAME}.M" \
              --gpg-fullname "Circle Builds" \
              --gpg-passphrase "${CIRCLE_SHA1}" \
              --wakatime-api-key "555-WAKATIME-BOGUS-API-KEY"
      - run:
          name: Verify !
          command: |
            zsh -mil -c echo "Veryfying the build ${CIRCLE_BUILD_NUM}"
            zsh -mil -c .circleci/verify_install.sh

workflows:
  version: 2
  verify:
    jobs:
      - submodules
  build:
    jobs:
      - build_arch
