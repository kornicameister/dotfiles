#!/usr/bin/env bash

# CI handling
CI=${CI:-False}
if [[ -n ${CI} ]]; then
    sudo() {
        "$@"
    }
fi

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

source "${BASEDIR}/.installer/utils.sh"
source "${BASEDIR}/.installer/git.sh"
if [[ "$(uname)" == "Darwin" ]]; then
    source "${BASEDIR}/.installer/install_mac.sh"
fi

install_links() {
    local cmd

    if command -v dotbot >/dev/null; then
        cmd="dotbot"
    else
        cmd="${BASEDIR}/dotbot/bin/dotbot"
    fi

    "${cmd}" -q -d "${BASEDIR}" -c "${BASEDIR}/install.conf.yaml"
}

post_install() {
    gem install \
        sqlint \
        neovim \
        2>/dev/null 1>/dev/null
    gem environment

    pipx ensurepath
    pipx install \
      cfn-lint \
      flake8 \
      pyinfra \
      wakatime \
      black \
      yamllint

    pipx install awsume[saml,fuzy]
    pipx inject awsume \
      awsume-console-plugin

    pipx install httpie
    pipx inject httpie \
      httpie-aws-auth

    pipx inject flake8 \
      flake8-bugbear==21.11.29 \
      flake8-commas==2.1.0 \
      flake8-quotes==3.3.1 \
      flake8-print==4.0.0 \
      flake8-bandit==2.1.2 \
      flake8-comprehensions==3.7.0

    wal --theme base16-atelier-dune -n --vte
    wal-vtop >/dev/null
}

_env_binary() {
    # fetches path to binary of given *env

    local env
    env="${1}"

    if ! command -v "${env}" >/dev/null 2>&1; then
        env_bin="${HOME}/.${env}/bin/${env}"
    else
        env_bin=$(command -v "${env}")
    fi

    echo "${env_bin}"
}

configure_envs() {
    configure_pyenv
    configure_nodenv
}

configure_nodenv() {
    local nodenv
    local nodenv_root

    nodenv=$(_env_binary "nodenv")
    nodenv_root=$($nodenv root)

    if [ ! -f "${nodenv_root}/version" ]; then
        echo "Installing latest Node"

        $nodenv latest install -s 14
        $nodenv global "$($nodenv latest --print-installed)"
        "${nodenv_root}/versions/$($nodenv latest --print-installed)/bin/npm" install --global --production "${BASEDIR}/package.json"

    else
        log_done "Node -> $(cat "${nodenv_root}/version")" "[  ]"
    fi

    $nodenv rehash
}

configure_pyenv() {
    local pyenv_root
    local python_icon="[  ]"
    local neovim_icon="[  ]${python_icon}"

    pyenv=$(_env_binary "pyenv")
    pyenv_root=$($pyenv root)

    if [ ! -f "${pyenv_root}/version" ]; then
        log_notice "Installing latest Python" "${python_icon}"

        for py_major in {2,3}; do
            $pyenv latest install -s "${py_major}"
            "${pyenv_root}/versions/$($pyenv latest --print-installed "${py_major}")/bin/pip" install --upgrade pip
            "${pyenv_root}/versions/$($pyenv latest --print-installed "${py_major}")/bin/pip" install \
                -r "${BASEDIR}/requirements/system.txt" \
                -r "${BASEDIR}/requirements/utils.txt"
            log_done "Installed Python ${py_major}" "${python_icon}"
        done

        $pyenv global "$($pyenv latest --print-installed)"
    else
        log_done "Python -> $(cat "${pyenv_root}/version")"
    fi

    for py_major in {2,3}; do
        if [ ! -d "${pyenv_root}/versions/neovim${py_major}" ]; then
            log_notice "Initializing neovim setup for Python ${py_major}" "${neovim_icon}"
            $pyenv virtualenv "$($pyenv latest --print "${py_major}")" "neovim${py_major}"
            "${pyenv_root}/versions/neovim${py_major}/bin/pip" install --upgrade pip
            "${pyenv_root}/versions/neovim${py_major}/bin/pip" install -r "${BASEDIR}/requirements/neovim.txt"
        else
            local neovim_py_version
            neovim_py_version="$(
                "${pyenv_root}/versions/neovim${py_major}/bin/python" \
                    --version \
                    2>&1 |
                    awk '{print $2}'
            )"
            log_done "neovim${py_major} -> ${neovim_py_version}" "${neovim_icon}"
        fi
    done

    $pyenv rehash
}

configure_nvim() {
    local goenv pyenv nodenv new_path old_path

    goenv=$(_env_binary "goenv")
    pyenv=$(_env_binary "pyenv")
    nodenv=$(_env_binary "nodenv")

    old_path="${PATH}"
    new_path="${PATH}:$($goenv root)/shims:$($pyenv root)/shims:$($nodenv root)/shims"

    export PATH="${new_path}"
    nvim --headless +PlugInstall +qall!
    nvim --headless +UpdateRemotePlugins +qall!
    export PATH="${old_path}"

    unset goenv
    unset pyenv
    unset nodenv
    unset new_path
}

configure_wakatime() {
    local wakatime_api_key=""
    wakatime_hostname="$(hostname)"

    while [[ $# -gt 0 ]]; do
        arg="${1}"
        case "${arg}" in
        --wakatime-api-key)
            wakatime_api_key="${2}"
            shift
            shift
            ;;
        --wakatime-hostname)
            wakatime_hostname="${2}"
            shift
            shift
            ;;
        --force)
          if test -f "${HOME}/.wakatime.cfg"; then
            mv -f "${HOME}/.wakatime.cfg{,.bak}" >/dev/null ;
          fi
          shift
          ;;
        esac
    done

    if [ ! -f "${HOME}/.wakatime.cfg" ]; then
        log_notice "Configuring Wakatime" "${icon}"
        if [ -z "${wakatime_api_key}" ]; then
            log_die "--wakatime-api-key required..." "${icon}"
        else
            install -m 666 "${BASEDIR}/wakatime.cfg" "${HOME}/.wakatime.cfg"
            sed -e "
                s|%API_KEY%|${wakatime_api_key}|g;
                s|%HOSTNAME%|${wakatime_hostname}|g;
            " -i "${HOME}/.wakatime.cfg"
            log_done "Wakatime configured" "${icon}"
        fi
    else
        log_done "Wakatime configured" "${icon}"
    fi
}

if ((SHLVL > 1)); then
    echo "kornicameister/dotfiles"

    if ((EUID == 0)) && [[ -z ${CI:-} ]]; then
        log_die "Altough root is required to install packages, ./install must not be launched as root" "${icon}" 3
    fi

    install_packages
    install_links

    configure_envs
    configure_git "$@"
    configure_nvim
    configure_wakatime "$@"

    post_install
    screenfetch
fi
