#!/usr/bin/env bash

# CI handling
CI=${CI:-False}
if [[ -n ${CI} ]]; then
    sudo() {
        "$@"
    }
fi

INSTALL_CONFIG="install.conf.yaml"
PKG_CONFIG="pkg.install.conf.yaml"

DOTBOT_DIR="dotbot"
DOTBOT_BIN="bin/dotbot"

BASEDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

USERNAME="${1:-""}"
PASSWORD="${2:-""}"
EMAIL="${3:-""}"

GPG_FULL_NAME="${4:-""}"
GPG_PASSPHRASE="${5:-""}"

_welcome_message() {
    if command -v lsb_release >/dev/null 2>&1; then
        distro_name=$(lsb_release -sd 2>&1)
    else
        distro_name="Unknown"
    fi

    if [ ! -f "${HOME}/.gitconfig.local" ]; then
        first_run_welcome="kornicameister/dotfiles - first run"
    else
        first_run_welcome="kornicameister/dotfiles - updating"
    fi

    echo "${distro_name} : ${first_run_welcome} : ${USERNAME}"
}

dotbot_pkg_install() {
    cd "${BASEDIR}" || exit 1
    sudo \
        "${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" \
        -v \
        -d "${BASEDIR}" \
        -p "${BASEDIR}/dependencies/dotbot_plugin_aptget/aptget.py" \
        -c "${PKG_CONFIG}"
    cd - || exit 1
}

dotbot_links() {
    cd "${BASEDIR}" || exit 1
    "${BASEDIR}/${DOTBOT_DIR}/${DOTBOT_BIN}" \
        -v \
        -d "${BASEDIR}" \
        -c "${INSTALL_CONFIG}"
    cd - || 1
}

setup_git() {
    # generate ssh key
    mkdir -p "${HOME}/.ssh"
    ssh-keygen \
        -t ed25519 \
        -b 4096 \
        -C "${EMAIL}" \
        -f "${HOME}/.ssh/github" \
        -N "${PASSWORD}"

    key_type="rsa"
    key_strength=4096
    key_config=$(mktemp)

    # generating GPK key to sign the commits
    cat >>"${key_config}" <<EOF
Key-Type: ${key_type}
Key-Length: ${key_strength}
Name-Real: ${GPG_FULL_NAME}
Name-Comment: ${USERNAME} GPG key generated with dotfiles
Name-Email: ${EMAIL}
Expire-Date: 0
Passphrase: ${GPG_PASSPHRASE}
EOF
    gpg2 --quiet --batch --expert --full-gen-key "${key_config}"
    rm -rf "${key_config}"

    # assumed the highest rsa length:
    local signingKey=""
    signingKey=$(gpg2 --list-secret-keys --keyid-format LONG | grep -B 2 "${EMAIL}" | grep sec | awk -F"[/ ]+" '{print $3}')

    if [ ! -f "${HOME}/.gitconfig.local" ]; then
        touch "${HOME}/.gitconfig.local"
    fi

    (
        git config --file="${HOME}/.gitconfig.local" user.name "${USERNAME}";
        git config --file="${HOME}/.gitconfig.local" user.email "${EMAIL}";
        git config --file="${HOME}/.gitconfig.local" user.signingKey "${signingKey}";
        git config --file="${HOME}/.gitconfig.local" gpg.program gpg2;
        git config --file="${HOME}/.gitconfig.local" commit.gpgsign true;
        git config --file="${HOME}/.gitconfig.local" github.user "${USERNAME}";
    )

    echo "Remember to upload the GPG and SSH keys to Github"
}

setup_nvim() (
    sudo update-alternatives --install /usr/bin/editor editor /usr/bin/nvim 1
    sudo update-alternatives --set editor /usr/bin/nvim

    if [ ! -f ~/.vim/autoload/plug.vim ]; then
        aria2c \
            -d ~/.vim/autoload \
            -o plug.vim \
            https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
    fi

    nvim --headless +PlugInstall +qall!
    nvim --headless +PlugClean! +qall!
    nvim --headless +UpdateRemotePlugins +qall!
)

latest_dev_install() (
    local pyenv
    local nodenv
    local goenv

    if ! command -v pyenv >/dev/null 2>&1; then
      pyenv="${HOME}/.pyenv/bin/pyenv"
    else
      pyenv=$(command -v pyenv)
    fi
    if ! command -v nodenv >/dev/null 2>&1; then
      nodenv="${HOME}/.nodenv/bin/nodenv"
    else
      nodenv=$(command -v nodenv)
    fi
    if ! command -v goenv >/dev/null 2>&1; then
      goenv="${HOME}/.goenv/bin/goenv"
    else
      goenv=$(command -v goenv)
    fi

    PYENV_ROOT=$($pyenv root)
    NODENV_ROOT=$($nodenv root)
    GOENV_ROOT=$($goenv root)

    if [ ! -f "${PYENV_ROOT}/version" ]; then
        echo "Installing latest Python"

        for py_major in {2,3}; do
            $pyenv latest install -s "${py_major}"
            "$(pyenv root)/versions/$(pyenv latest --print-installed $py_major)/bin/pip" install -r "${PWD}/python-system-requirements.txt"
        done

        $pyenv global "$($pyenv latest --print-installed 3)"
    else
        echo "pyenv already has system version set at it is $(cat "${PYENV_ROOT}/version")"
    fi

    if [ ! -f "${NODENV_ROOT}/version" ]; then
        echo "Installing latest Node"

        $nodenv latest install -s 12
        $nodenv global "$($nodenv latest --print-installed 12)"
    else
        echo "nodenv already has system version set at it is $(cat "${NODENV_ROOT}/version")"
    fi

    if [ ! -f "${GOENV_ROOT}/version" ]; then
        echo "Installing latest GO"

        $goenv latest install -s 1
        $goenv global "$($goenv latest --print-installed 1)"
    else
        echo "goenv already has system version set at it is $(cat "${GOENV_ROOT}/version")"
    fi


    for py_major in {2,3}; do
        if [ ! -d "${PYENV_ROOT}/versions/neovim${py_major}" ]; then
            echo "Initializing neovim setup for Python ${py_major}"
            $pyenv virtualenv "$($pyenv latest --print ${py_major})" "neovim${py_major}"
            "${PYENV_ROOT}/versions/neovim${py_major}/bin/pip" install -r ./neovim-requirements.txt
        else
            echo "${PYENV_ROOT}/versions/neovim${py_major} venv already exists"
        fi
        $pyenv virtualenvs | grep "neovim${py_major}"
    done

    $pyenv rehash
    $nodenv rehash
)

_welcome_message
git submodule update --init --recursive

if [ ! -f "${HOME}/.gitconfig.local" ]; then
    args=("$@")
    argsCount=${#args[@]}

    if [ "${argsCount}" -ne 5 ]; then
        echo "Invalid arguments, example: ./install {git_user} {git_password} {git_email} {gpg_full_name} {gpg_passphrase}"
    fi
    if [ -z "${USERNAME}" ]; then
        echo "git_user must be set"
        exit 1
    fi
    if [ -z "${PASSWORD}" ]; then
        echo "git_password must be set"
        exit 2
    fi
    if [ -z "${EMAIL}" ]; then
        echo "git_email must be set"
        exit 3
    fi
    if [ -z "${GPG_FULL_NAME}" ]; then
        echo "gpg_full_name must be set"
        exit 4
    fi
    if [ -z "${GPG_PASSPHRASE}" ]; then
        echo "gpg_passphrase must be set"
        exit 5
    fi


    dotbot_pkg_install
    dotbot_links
    setup_git
    latest_dev_install
    setup_nvim

else

    dotbot_links
    latest_dev_install
    setup_nvim

fi
